{% extends './base.html' %}
{% block content %}
<!-- Content Wrapper. Contains page content -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
 
<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>

    
<style>
.content-wrapper{
  
}
.content{
    
}
.form{
    border: 5px solid #fafafa;
  padding: 1em;
    width: 100%;
  text-align: center;
  background-color: #ffffff;
}
.student_box{
    
}
.student_table{
    border: 5px solid #fafafa;
    padding: 1em;
    width: 100%;
    text-align: center;
    background-color: #ffffff;
  
}
td{
    
}
.student_th{
    border: 2px solid #fafafa;
    background-color: #c2c1c1;
   
    
}
.student_td{
    
    border-bottom: 1px solid #b0b0b0;
    border-right: 2px solid #ffffff;
   background-color: #fafafa;
   height: 15px;
   
}
.red_td{
    background-color: #f7e7db;
}
.blue_td{
    background-color: #d9eef3;
}
.student_check{
    width:2%;
    min-width: 25px;
}
.student_name{
    width: 10%;
    min-width: 70px;
}
.student_classroomuser{
    width: 10%;
    min-width: 70px;
}
.student_mail{
    width: 15%;
    min-width: 70px;
}
.student_phone{
    width: 8%;
    min-width: 70px;
}
.student_address{
    width: 15%;
    min-width: 70px;
}
.student_subject{
    width: 15%;
    min-width: 70px;
}
.student_school{
    text-align: left;
    min-width: 70px;
}
.student_text{
    width: 70%;
    min-width: 50px;
    position: relative;
    text-align: left;
}
.student_id{
    width: 10%;
    min-width: 50px;
   
}

.teacher_text{
    width: 60%;
   
    position: absolute;
    top: 30px; /* 上を基準 */
    left: 0;      
}
.teacher_text textarea,.manager_text textarea{
  width: 80%;
  height: 85px;
}
.manager_text{
    width: 50%;
    margin: 5px;
    position: absolute;
    top: 30px; /* 上を基準 */
    left: 50%;      
}
.approval_button{
    position:absolute;
    top: 60%;
    right: 1%;
    width: 7%;
}
.detail_button{
    position:absolute;
    top: 20%;
    right: 1%;
    width: 7%;
}
.lesson_data{
    position:absolute;
    top: 5%;
    left: 1%;
    width: 100%;
}
.active_box{
    display: none;
}

    .student_table:hover {
        background-color: #252323; /* マウスオーバー時の背景色 */
    }





    form {
        width: 100%;
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
        font-family: Arial, sans-serif;
        background-color: #f9f9f9;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    /* 各ラベル */
    label {
        font-size: 14px;
        color: #333;
        margin-bottom: 5px;
        display: block;
    }

    /* 入力フィールド */
    input[type="text"],
    input[type="email"],
    select {
        width: 100%;
        padding: 8px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 5px;
        margin-bottom: 15px;
    }

    /* 必須項目のマーク */
    .text-danger {
        color: #e74c3c;
        font-size: 12px;
    }

    /* 横並びレイアウト */
    .input-row {
        display: flex;
        justify-content: space-between;
        gap: 20px;
        flex-wrap: wrap;
    }
    .input-row-subjects {
        display: flex;
        justify-content:left;
        
        flex-wrap: wrap;
    }
    .input-row div {
        flex: 1;
    }

    /* 入力フィールドに対するエラーメッセージ */
    #subject-error-message {
        font-size: 12px;
        margin-top: 5px;
        color: #e74c3c;
    }

    /* ボタンのスタイル */
    .btn {
        background-color: #3498db;
        color: white;
        padding: 10px 15px;
        font-size: 14px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    .btn:hover {
        background-color: #2980b9;
    }

    /* チェックボックスのスタイル */
    #subject-checkboxes input[type="checkbox"] {
        margin-right: 10px;
    }

    /* 小さなフォントサイズ */
    .text-sm {
        font-size: 12px;
    }


    .student_table .student_td:hover {
    background-color: #f0f8ff; /* Change to your preferred color */
    cursor: pointer; /* Optional: changes the cursor to a pointer to improve UX */
}

/* If you want to highlight the entire row when hovering over a cell */
.student_table tr:hover {
    background-color: #f0f8ff; /* Change to your preferred hover color */
}





</style>
<div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">      
        <h1>生徒一覧</h1>
        <ol class="breadcrumb">
            <li><a href="#"><i class="fa fa-child"></i>生徒</a></li>
            <li class="active">生徒一覧</li>
        </ol>
    </section>
    <section class="content">
        <div class="box">
           
<form method="POST">
    <div class="input-row">
        
        <div>
            <label for="form_student_name">名前 <span class="text-sm text-danger">必須</span></label>
            <input type="text" required name="form_student_name" id="form_student_name">
        </div>
        
        <div>
            <label for="form_student_classroomuser">所属教室 <span class="text-sm text-danger">必須</span></label>
            <select required name="form_student_classroomuser" id="form_student_classroomuser">
            </select>
        </div>
        <div>
            <label for="form_student_id">ゲームID </label>
            <input type="text"  name="form_student_id" id="form_student_id">
        </div>
        
    </div>

    <div class="input-row">
        <div>
            <label for="form_student_mail">配信用メールアドレス <span class="text-sm text-danger">必須</span></label>
            <input type="email" required name="form_student_mail" id="form_student_mail">
        </div>
        <div>
            <label for="form_student_post">郵便番号</label>
            <input pattern="\d+" placeholder="数字" type="text" name="form_student_post" id="form_student_post">
        </div>
        <div>
            <label for="form_student_address">住所</label>
            <input type="text" name="form_student_address" id="form_student_address">
        </div>
    </div>

 
        <div id="student-phones-container">
            <h4>電話番号</h4>
               
            <div class="student-phone-entry"><div class="input-row">
                <div>
                    <label for="student_phone_1">誰の電話番号か</label>
                    <input type="text" name="student_phone_name_1" id="student_phone_name_1">
                </div>
                <div>
                    <label for="student_phone_number_1">電話番号</label>
                    <input type="text" name="student_phone_number_1" id="student_phone_number_1" pattern="\d+" placeholder="数字">
                </div>
            </div>
        </div>
    </div>
        <!-- プラスボタン -->
        <input type="button" value="＋" id="add-phone-btn" class="btn btn-secondary">
    
        
    

    <div class="input-row">
        <div>
            <label for="form_student_stage">教育段階 <span class="text-sm text-danger">必須</span></label>
            <select name="form_student_stage" id="form_student_stage">
                <option value="小学生">小学生</option>
                <option value="中学生">中学生</option>
                <option value="高校生">高校生</option>
                <option value="大学生">大学生</option>
                <option value="その他">その他</option>
            </select>
        </div>
        <div>
            <label for="form_student_grade">学年 <span class="text-sm text-danger">必須</span></label>
            <select name="form_student_grade" id="form_student_grade" >
                <option value="1">1年生</option>
                <option value="2">2年生</option>
                <option value="3">3年生</option>
                <option value="4">4年生</option>
                <option value="5">5年生</option>
                <option value="6">6年生</option>
                <option value="その他">その他</option>
            </select>
        </div>
    </div>
    <div class="input-row">
    <div>
        <label for="form_student_schoolclass">組</label>
        <input type="text" name="form_student_schoolclass" id="form_student_schoolclass">
    </div>

    <div>
        <label for="form_student_school">学校名</label>
                <select required name="form_student_school" id="form_student_school">
   </select>
    </div>
    </div>
    <div >
        <label for="form_student_subjects">選択科目</label>
        <div id="subject-checkboxes"  class="input-row-subjects">
            <!-- チェックボックスがJavaScriptによってここに追加されます -->
        </div>
        <div id="subject-error-message" style="display: none;">少なくとも1つの科目を選択してください！</div>
    </div>
    {% csrf_token %}
    <input type="button" value="保存" class="btn btn-primary" onclick="createStudent()">
</form>
            

        </div>
        <div class="assessment_box">
            <table class="student_table" style="border-collapse:collapse;border:none;" >
                <thead>
                <tr >
                    <td class="student_th student_check">
                        <input type="checkbox" id="student_check" name="student_check">
                    </td>
                    <td class="student_th student_name">
                        名前
                    </td>
                    <td class="student_th student_classroomuser">
                        教室
                    </td>
                    <td class="student_th student_id">
                        ゲームID
                    </td>
                    <td class="student_th student_mail"> 
                        配信用メールアドレス
                    </td>
                    <td class="student_th student_phone"> 
                        電話番号
                    </td>
                 
                    <td  class="student_th student_address"> 
                        住所
                    </td>
                    <td class="student_th student_school"> 
                        学校
                    </td>
                    <td class="student_th student_subject"> 
                        選択科目
                    </td>
                   
                </tr> 
            </thead>
        </table>
            <div id="student-list">
                <!-- JavaScript will insert rows here -->
            </div>
       
    </div>
</section>
</div>
<script>



const addTableListeners = () =>{
    const tables = document.querySelectorAll('.student_table');
    tables.forEach(function(table) {
        table.addEventListener('click', function() {
            const form = table.nextElementSibling;
            if (form && form.classList.contains('active_box')) {
                // 現在の表示状態を確認し、切り替える
                const isVisible = form.style.display === 'block';

                // すべてのフォームを非表示に
                document.querySelectorAll('.active_box').forEach(function(box) {
                    box.style.display = 'none';
                });

                // クリックしたテーブルのフォームを表示/非表示に切り替え
                form.style.display = isVisible ? 'none' : 'block';
            }
        });
    });
}

 

    
const StudentListElement = document.getElementById('student-list');
const printList = () => {
    $.ajax({
        'url': '{% url "classmanager:classroom_users_endpoint" %}',  // Make sure this points to the correct view
        'type': 'GET',
        
    }).done(response => {
        // Assuming response.classroom_users is an array of objects with `id` and `username`
        const classroomUserSelect = document.getElementById('form_student_classroomuser');

        // Clear existing options
        classroomUserSelect.innerHTML = '';

        // Populate the select element with new options
        response.classroom_users.forEach((user) => {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = user.username;
            classroomUserSelect.appendChild(option);
        });
    }).fail(error => {
        console.error('Error fetching classroom users:', error);
    });
    $.ajax({
        'url': '{% url "classmanager:ajax_get_printstudentlist" %}',
        'type': 'GET',
        'data': {'title': 'post'},
    }).done(response => {
        StudentListElement.innerHTML = ''; 
        let studentList = response.studentlist;
        let schoolList = response.schoollist;
        let subjectList = response.subjectlist;
        let allSubjectList = response.all_subjectlist; 
        let classroomuserList =response.classroom_users // すべての科目情報

        // Create dictionaries for school and subject information
        const schoolDict = {};
        const schoolDictnew = {};
        schoolList.forEach(school => {
            const schoolFields = school.fields;
            const schoolpkFields = school.pk;
            schoolDictnew[schoolpkFields] = schoolFields;
            schoolDict[schoolFields.student] = schoolFields;
        });

        const schoolSubjectDict = {};
        subjectList.forEach(subjectEntry => {
            const schoolId = subjectEntry.school_id;
            if (!schoolSubjectDict[schoolId]) {
                schoolSubjectDict[schoolId] = [];
            }
            schoolSubjectDict[schoolId].push(subjectEntry.subject_title);
        });
      

        studentList.forEach(student => {
            const studentFields = student.fields; 
            const studentPk = student.pk;
            const classroomUserSelectHtml = (response.classroom_users || []).map(user => {
    const isSelected = (user.id === studentFields.classroomuser) ? 'selected' : '';
    return `<option value="${user.id}" ${isSelected}>${user.username}</option>`;
}).join('');

    const filteredEntries = Object.entries(schoolDictnew).filter(([key, value]) => value.student === studentPk);
    const schoolFormsHtml = filteredEntries.map(([key, schoolInfo]) => {
    const relatedSubjects = schoolSubjectDict[key] || [];

    let subjectHtml = ''
    allSubjectList.forEach(subject => {
        const isChecked = relatedSubjects.includes(subject.title) ? 'checked' : '';
        
        subjectHtml+= `       
            <input type="checkbox" value="${subject.id}" ${isChecked}> ${subject.title}`;
    });

    // 学年セレクトオプションを構築
    const gradeOptions = [
        { value: "1", label: "1年生" },
        { value: "2", label: "2年生" },
        { value: "3", label: "3年生" },
        { value: "4", label: "4年生" },
        { value: "5", label: "5年生" },
        { value: "6", label: "6年生" },
        { value: "その他", label: "その他" }
    ];

    // 学年セレクトボックスのHTML生成
    const gradeSelectHtml = gradeOptions.map(option => {
        const isSelected = option.value == schoolInfo.grade ? 'selected' : '';
        return `<option value="${option.value}" ${isSelected}>${option.label}</option>`;
    }).join('');

    // 教育段階セレクトオプションを構築
    const stageOptions = [
        { value: "小学生", label: "小学生" },
        { value: "中学生", label: "中学生" },
        { value: "高校生", label: "高校生" },
        { value: "大学生", label: "大学生" },
        { value: "その他", label: "その他" }
    ];

    // 教育段階セレクトボックスのHTML生成
    const stageSelectHtml = stageOptions.map(option => {
        const isSelected = option.value == schoolInfo.stage ? 'selected' : '';
        return `<option value="${option.value}" ${isSelected}>${option.label}</option>`;
    }).join('');

    const currentStage = schoolInfo.stage;

    // Fetch the list of schools for this stage from the response
    const schoolOptions = (response.filtered_schools[currentStage] || []).map(school => {
        const isSelected = school.name === schoolInfo.school ? 'selected' : '';
        return `<option value="${school.id}" ${isSelected}>${school.name}</option>`;
    }).join('');

    document.querySelectorAll('[id^="form_student_stage_"]').forEach(stageSelect => {
    stageSelect.addEventListener('change', event => {
        // 選択された教育段階を取得
        const selectedStage = event.target.value;
        
        // `key`を取得
        const key = event.target.id.split('_').pop(); // "_{key}"の後ろの部分を取得

        // 対応する学校リストを取得
        const schoolsForSelectedStage = response.filtered_schools[selectedStage] || [];

        // 新しいschoolSelectHtmlを生成
        const newSchoolOptions = schoolsForSelectedStage.map(school => {
            return `<option value="${school.id}">${school.name}</option>`;
        }).join('');

        // 学校の選択ボックスを更新
        const schoolSelect = document.getElementById(`form_student_school_${key}`);
        schoolSelect.innerHTML = newSchoolOptions;
    });
});

    // Create school select HTML
    const schoolSelectHtml = `
        <label for="form_student_school_${key}">学校</label>
        <select name="form_student_school" id="form_student_school_${key}">
            ${schoolOptions}
        </select>
    `;

    return `
    <div data-school-id=${key} >
        <div class="input-row">
        <div>
            <label for="form_student_stage_${key}">教育段階</label>
            <select name="form_student_stage_${key}" id="form_student_stage_${key}">
                ${stageSelectHtml}
            </select>
        </div>
        <div>
            <label for="form_student_grade_${key}">学年</label>
            <select name="form_student_grade_${key}" id="form_student_grade_${key}">
                ${gradeSelectHtml}
            </select>
        </div>
        <div>
            <label for="form_student_schoolclass_${key}">組</label>
            <input type="text" value="${schoolInfo.schoolclass}" name="form_student_schoolclass_${key}" id="form_student_schoolclass_${key}">
        </div>
        <div>
            ${schoolSelectHtml}
        </div>
        </div>
        <div>
            <label>科目:</label>
            ${subjectHtml}
        </div>
        <div style="display:inline;">
            <input type="button" value="保存" class="btn btn-primary" onclick="updateStudentSchool(${key})">
            <input type="button" value="削除" class="btn btn-danger" onclick="deleteStudentSchool(${key})">
        </div>
    </div>
    `;
}).join('');



const studentSubjectsHtml = filteredEntries.map(([key, schoolInfo]) => {
    // `key`は学校のIDで、そのIDを使って`schoolSubjectDict`から関連科目を取得
    const subjects = schoolSubjectDict[key] || [];
    // 科目が配列かどうか確認

    // 各科目をHTMLに変換して結合
    return subjects.map(subject => `<span>${subject}</span>`).join('　');
}).join('<br>');


const studentPhonesHtml = (response.student_phone_data[studentPk] || []).map(phoneInfo => {
    return `<span>${phoneInfo.phone || ''} (${phoneInfo.text || ''})</span>`;
}).join('<br>');

const phoneFormsHtml=(response.student_phone_data[studentPk] || []).map(phoneInfo => {
    return `
    
    <div class="input-row">
    <div>
                <label for="student_phone_${phoneInfo.id || ''}">誰の電話番号か</label>
                <input type="text" value='${phoneInfo.text || ''}' name="student_phone_name_${phoneInfo.id || ''}" id="student_phone_name_${phoneInfo.id || ''}">
            </div>
            <div>
                <label for="student_phone_number_${phoneInfo.id || ''}">電話番号</label>
                <input type="text" value='${phoneInfo.phone || ''}' name="student_phone_number_${phoneInfo.id || ''}" pattern="\\d+" placeholder="数字">
            </div>
            </div>
  
    `
    ;
}).join('<br>');
// テーブルの中で正しい場所に挿入
const row = document.createElement('div');
row.setAttribute('data-student-id', studentPk);
row.innerHTML = `
    <table class="student_table" style="border-collapse:collapse;border:none;">
        <tr>
            <td class="student_td student_check">
                <input type="checkbox" id="student_check" name="student_check">
            </td>
            <td class="student_td red_td student_name">
                ${studentFields.name}
            </td>
            <td class="student_td  student_classroomuser">
                ${studentFields.classroomusername}
            </td>
            <td class="student_td student_id">
                ${studentFields.student_id}
            </td>
            <td class="student_td student_mail">
                ${studentFields.mail}
            </td>
            <td class="student_td student_phone">
               ${studentPhonesHtml} <!
            </td>
            <td class="student_td student_address">
                ${studentFields.post}<br>${studentFields.address}
            </td>
            <td class="student_td student_school school_list">
                ${filteredEntries.map(([key, schoolInfo]) => `区分〔${schoolInfo.stage}〕 学年〔${schoolInfo.grade}〕 組〔${schoolInfo.schoolclass}〕  　<span style="color: black;">${schoolInfo.school}</span>`).join('<br>')}
            </td>
            <td class="student_td student_subject">
                ${studentSubjectsHtml} <!-- 科目リスト -->
            </td>
        </tr>
    </table>
                <div class="active_box box" style="display: none;">
                    <form>
                        <div class="input-row">
                        <div >
                            <label for="form_student_name">名前 <span class="text-sm text-danger ">必須</span></label>
                            <input type="text" required value="${studentFields.name}" name="form_student_name" id="form_student_name">
                        </div>
                         <div>
                                 <label for="form_student_classroomuser">所属教室 <span class="text-sm text-danger">必須</span></label>
                                <select required name="form_student_classroomuser" id="form_student_classroomuser">
                                    ${classroomUserSelectHtml}
                                </select>
                            </div>
                            <div >
                            <label for="form_student_id">ゲームID </label>
                            <input type="text" required value="${studentFields.student_id}" name="form_student_id" id="form_student_id">
                        </div>
                       
                        </div>
                        <div class="input-row">
                             <div>
                            <label for="form_student_mail">配信用メールアドレス<span class="text-sm text-danger ">必須</span></label>
                            <input type="email" required value="${studentFields.mail}" name="form_student_mail" id="form_student_mail">
                        </div>
                        <div>
                            <label for="form_student_post">郵便番号</label>
                            <input type="text" value="${studentFields.post}" name="form_student_post" id="form_student_post">
                        </div>
                        
                        <div>
                            <label for="form_student_address">住所</label>
                            <input type="text" value="${studentFields.address}" name="form_student_address" id="form_student_address">
                        </div>
                        </div>
                        <div class="student_phone_add">
                            <label for="form_student_phone">電話番号</label>
                            ${phoneFormsHtml}
                        </div>

                    <input type="button" value="＋" id="add-phone-btn" class="btn btn-secondary" onclick="addformStudentphone(${studentPk})">
                    <input type="button" value="−" id="remove-phone-btn" class="btn btn-secondary" onclick="removeformStudentphone(${studentPk})">
                        <br>          
                        
                         <div style="display:inline;">
                            <input type="button" value="保存" class="btn btn-primary" onclick="updateStudent(${studentPk})">
                            <input type="button" value="削除" class="btn btn-danger" onclick="deleteStudent(${studentPk})">
                        </div>
                        ${schoolFormsHtml}
                       
                    </form>
                     <div style="display:inline;">
                        <input type="button" value="学校を追加" class="btn btn-info" onclick="addformStudentSchool(${studentPk})">
                    </div>
                </div>
            `;

            StudentListElement.appendChild(row);
            
        });

        addTableListeners();
    });
}




function createStudent() {
    var form = document.querySelector('form');
    const checkboxes = document.querySelectorAll('input[name="subjects"]:checked');
    const errorMessage = document.getElementById('subject-error-message');
  
    if (checkboxes.length < 1) {
        errorMessage.style.display = 'block';  // エラーメッセージを表示
        return false;  // フォーム送信をキャンセル
    }
    
   
    errorMessage.style.display = 'none';  // エラーメッセージを非表示
      // フォーム送信を許可
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    const phoneEntries = document.querySelectorAll('.student-phone-entry');
    const studentPhones = Array.from(phoneEntries).map(entry => ({
        name: entry.querySelector('input[name^="student_phone_name_"]').value,
        number: entry.querySelector('input[name^="student_phone_number_"]').value
    }));
    const studentClassroomUser = document.getElementById('form_student_classroomuser').value;
    const studentName = document.getElementById('form_student_name').value;
    const studentId = document.getElementById('form_student_id').value;
    const studentMail = document.getElementById('form_student_mail').value;
    const studentPost = document.getElementById('form_student_post').value;
    const studentAddress = document.getElementById('form_student_address').value;
    
    const studentSchool = document.getElementById('form_student_school').value;
    const studentGrade = document.getElementById('form_student_grade').value;
    const studentSchoolClass = document.getElementById('form_student_schoolclass').value;
    const studentStage = document.getElementById('form_student_stage').value;
   

    // 選択された科目のIDを取得
    const selectedSubjects = Array.from(document.querySelectorAll('input[name="subjects"]:checked')).map(checkbox => checkbox.value);

    // Ajaxリクエストを送信
    const csrftoken = Cookies.get('csrftoken'); 

    const postBody = {
            student_classroomuser : studentClassroomUser,
            student_name: studentName,
            student_id:studentId,
            student_mail: studentMail,
            student_post: studentPost,
            student_address: studentAddress,
            student_phones: studentPhones ,
            student_school: studentSchool,
            student_grade: studentGrade,
            student_schoolclass: studentSchoolClass,
            student_stage: studentStage,
            student_subjects: selectedSubjects // カンマ区切りで送信
    };

    $.ajax({
        url: '{% url "classmanager:ajax_get_createstudentlist" %}',
        type: 'POST',
        dataType: 'json',
        headers: {
            "X-CSRFToken": csrftoken, 
        },
        data: JSON.stringify(postBody),
        success: function(response) {
            if (response.success) {
                printList();
                location.reload();

            } else {
                alert(response.message);
            }
        },
        error: function(error) {
            alert("通信エラーが発生しました。");
        }
    });
}

function updateStudent(studentId) {
    const form = document.querySelector(`#student-list div[data-student-id="${studentId}"] form`);
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const name = form.querySelector(`#form_student_name`).value;
    const studentgame_id = form.querySelector(`#form_student_id`).value;
    const classroomuser = form.querySelector(`#form_student_classroomuser`).value;
    const mail = form.querySelector(`#form_student_mail`).value;
    const post = form.querySelector(`#form_student_post`).value;
    const address = form.querySelector(`#form_student_address`).value;
    
    // 電話番号データの収集
    const phoneData = [];
    form.querySelectorAll('.student_phone_add .input-row').forEach(row => {
        const phoneName = row.querySelector(`input[name^="student_phone_name_"]`).value;
        const phoneNumber = row.querySelector(`input[name^="student_phone_number_"]`).value;
        if (phoneName && phoneNumber) {
            phoneData.push({ phoneName, phoneNumber });
        }
    });

    $.ajax({
        url: '{% url "classmanager:ajax_get_updatastudentlist" %}',
        type: 'POST', // POSTの使用を検討
        data: {
            'student_id': studentId,
            'studentgame_id':studentgame_id,
            'student_classroomuser': classroomuser,
            'student_name': name,
            'student_mail': mail,
            'student_post': post,
            'student_address': address,
            'phone_data': JSON.stringify(phoneData), // JSON文字列としてデータを送信
        },
        success: function(response) {
            if (response.success) {
                printList();
            } else {
                alert(response.message);
            }
        },
        error: function() {
            alert("通信エラーが発生しました。");
        }
    });
}

const deleteStudent = (studentId) => {
    const userConfirmed = confirm('この学生を削除してもよろしいですか関連する情報がすべて削除されます');

    if (userConfirmed) {
    $.ajax({
        'url': '{% url "classmanager:ajax_get_deletestudentlist" %}',
        'type': 'GET',
        'data': {'student_id': studentId}
    }).done(response => {
        printList(); // 学生リストを再読込み
        // if (response.success) {
        //     alert("学生が正常に削除されました。");
        //     printList(); // 学生リストを再読込み
        // } else {
        //     alert("学生削除に失敗しました。");
        // }
    // }).fail(() => {
    //     alert("AJAXリクエストでエラーが発生しました。");
    
    });
}
};



function addformStudentSchool(studentPk) {
    const container = document.querySelector(`#student-list div[data-student-id="${studentPk}"] .active_box`);
    const existingForm = container.querySelector(`#form_student_stage_${studentPk}`);
    
    if (existingForm) {
        return; // 既にフォームが存在する場合は追加しない
    }
    
    const form = document.createElement('form');
    form.innerHTML = `
    <div data-school-id="${studentPk}">
        <div>
            <label for="form_student_stage_${studentPk}">教育段階</label>
            <select name="form_student_stage" id="form_student_stage_${studentPk}">
                <option value="小学生">小学生</option>
                <option value="中学生">中学生</option>
                <option value="高校生">高校生</option>
                <option value="大学生">大学生</option>
                <option value="その他">その他</option>
            </select>
        </div>
        <div>
            <label for="form_student_grade_${studentPk}">学年</label>
            <select name="form_student_grade" id="form_student_grade_${studentPk}">
                <option value="1">1年生</option>
                <option value="2">2年生</option>
                <option value="3">3年生</option>
                <option value="4">4年生</option> 
                <option value="5">5年生</option>
                <option value="6">6年生</option>
                <option value="その他">その他</option>
            </select>    
        </div>
        <div>
            <label for="form_student_schoolclass_${studentPk}">組</label>
            <input type="text" name="form_student_schoolclass" id="form_student_schoolclass_${studentPk}">
        </div>
        <div>
            <label for="form_student_school_${studentPk}">学校</label>
            <select name="form_student_school" id="form_student_school_${studentPk}">
            </select>
        </div>
        <div id="subject-checkboxes-${studentPk}">
            <label for="form_student_subjects">選択科目</label>
            <!-- チェックボックスはここに追加されます -->
        </div>
        <input type="button" value="保存" class="btn btn-primary" onclick="createStudentSchool(${studentPk})">
    </div>
    <div id="subject-error-message" style="color: red; display: none;">
        少なくとも1つの科目を選択してください！
    </div>
    `;

    container.appendChild(form);

    // fetchSubjectsを呼び出してチェックボックスを追加
    addfetchSubjects(studentPk);

    // 新しいStageセレクトボックスの変更イベントを設定
    const stageSelect = document.getElementById(`form_student_stage_${studentPk}`);
    const schoolSelect = document.getElementById(`form_student_school_${studentPk}`);

    function updateSchoolsStage(studentPk, stage) {
        $.ajax({
            url: '{% url "classmanager:get_schools" %}',
            data: {
                'stage': stage
            },
            dataType: 'json',
            success: function(data) {
                schoolSelect.innerHTML = ''; // 既存の選択肢をクリア
                data.schools.forEach(function(school) {
                    schoolSelect.appendChild(new Option(school, school));
                });
            }
        });
    }

    // 新しいstageセレクトの変更イベントを追加
    stageSelect.addEventListener('change', function() {
        const selectedStage = stageSelect.value;
        updateSchoolsStage(studentPk, selectedStage);
    });

    // 初期状態で学校を更新
    const initialStage = stageSelect.value;
    updateSchoolsStage(studentPk, initialStage);
}
function updateStudentSchool(schoolId) {
    const stage = document.getElementById(`form_student_stage_${schoolId}`).value;
    const grade = document.getElementById(`form_student_grade_${schoolId}`).value;
    const schoolClass = document.getElementById(`form_student_schoolclass_${schoolId}`).value;
    const schoolName = document.getElementById(`form_student_school_${schoolId}`).value;
    console.log(schoolClass)
    const subjects = [];
    document.querySelectorAll(`[data-school-id="${schoolId}"] input[type="checkbox"]:checked`).forEach(checkbox => {
        subjects.push(checkbox.value);
    });

    $.ajax({
        url: '{% url "classmanager:ajax_get_updatastudentschool" %}',
        type: 'GET',
        data: {
            'school_id': schoolId,
            'student_stage': stage,
            'student_grade': grade,
            'student_schoolclass': schoolClass,
            'student_school': schoolName,
            'subjects': JSON.stringify(subjects),
        },
        success: function(response) {
            if (response.success) {
                alert('学校と科目が正常に更新されました。');
            } else {
                alert('学校と科目の更新に失敗しました。');
            }
        },
        error: function() {
            alert('学校と科目の更新中にエラーが発生しました。');
        }

    });
    printList();

}
function deleteStudentSchool(schoolId) {
    const userConfirmed = confirm('この学校データを削除してもよろしいですか？');
  
    if (userConfirmed) {
        $.ajax({
            url: '{% url "classmanager:ajax_delete_student_school" %}', // 正しいURLの指定
            type: 'GET',
            data: { 'school_id': schoolId },
            success: function(response) {
                if (response.success) {
                    
                    alert("学校データが削除されました。");
                    printList(); // 更新後のリスト表示
                } else {
                    alert("削除に失敗しました: " + response.error);
                }
            },
            error: function() {
                alert("通信エラーが発生しました。");
            }
        });
    }
}

function createStudentSchool(studentPk) {
    const stage = document.getElementById(`form_student_stage_${studentPk}`).value;
    const grade = document.getElementById(`form_student_grade_${studentPk}`).value;
    const schoolClass = document.getElementById(`form_student_schoolclass_${studentPk}`).value;
    const schoolName = document.getElementById(`form_student_school_${studentPk}`).value;
    
    const subjects = [];
    document.querySelectorAll(`#subject-checkboxes-${studentPk} input[type="checkbox"]:checked`).forEach(checkbox => {
        subjects.push(checkbox.value);
    });

    if (subjects.length === 0) {
        alert('少なくとも1つの科目を選択してください！');
        return;
    }

    $.ajax({
        url: '/ajax/create_student_school/',  // This should match the Django URL pattern
        type: 'GET',
        data: {
            'student_id': studentPk,
            'student_stage': stage,
            'student_grade': grade,
            'student_schoolclass': schoolClass,
            'student_school': schoolName,
            'subjects': JSON.stringify(subjects)
        },
        success: function(response) {
            if (response.success) {
                alert('データが保存されました!');
                // Optionally, clear the form or provide feedback
            } else if (response.error) {
                alert(`エラー: ${response.error}`);
            }
        },
        error: function() {
            alert('データ保存中にエラーが発生しました。');
        }
    });
    printList();
}
function addfetchSubjects(studentPk) {
    $.ajax({
        url: '/ajax/get_subjects/',  // Djangoで設定したエンドポイントに一致させる
        type: 'GET',
        success: function(response) {
            if (response.subjects) {
                const subjects = response.subjects;
                const container = document.getElementById(`subject-checkboxes-${studentPk}`);
                
                // チェックボックスを動的に追加
                subjects.forEach(subject => {
                    const label = document.createElement('label');
                    label.textContent = subject.title;

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.name = `subjects_${studentPk}`;
                    checkbox.value = subject.id;
                    
                    container.appendChild(checkbox);
                    container.appendChild(label);
                    // container.appendChild(document.createElement('br'));
                });
            } else {
                alert("科目のリストを取得できませんでした。");
            }
        },
        error: function() {
            alert("科目のリスト取得中にエラーが発生しました。");
        }
    });
}


function fetchSubjects() {
    $.ajax({
        url: '/ajax/get_subjects/',  // Djangoで設定したエンドポイントに一致させる
        type: 'GET',
        success: function(response) {
            if (response.subjects) {
                const subjects = response.subjects;
                const container = document.getElementById('subject-checkboxes');
                
                subjects.forEach(subject => {
                    const label = document.createElement('label');
                    label.textContent = subject.title;

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.name = 'subjects';
                    checkbox.value = subject.id;
                    
                    container.appendChild(checkbox);
                    container.appendChild(label);
                    // container.appendChild(document.createElement(''));
                });
            } else {
                alert("科目のリストを取得できませんでした。");
            }
        },
        error: function() {
            alert("科目のリスト取得中にエラーが発生しました。");
        }
    });
}
function validateForm() {
    const checkboxes = document.querySelectorAll('input[name="subjects"]:checked');
    const errorMessage = document.getElementById('subject-error-message');
    
    // チェックボックスが選択されていない場合
    if (checkboxes.length < 1) {
        errorMessage.style.display = 'block';  // エラーメッセージを表示
        return false;  // フォーム送信をキャンセル
    }
    
    // チェックボックスが選択されている場合
    errorMessage.style.display = 'none';  // エラーメッセージを非表示
    return true;  // フォーム送信を許可
}


let tablephoneCounter=0;
function addformStudentphone(studentPk) {
    tablephoneCounter++;
    const container = document.querySelector(`#student-list div[data-student-id="${studentPk}"] .student_phone_add`);
    const form = document.createElement('div');

    form.className = `input-row student_phone_${tablephoneCounter}`;
    form.innerHTML = `
        <div>
            <label for="student_phone_${tablephoneCounter}">誰の電話番号か</label>
            <input type="text" name="student_phone_name_${tablephoneCounter}" id="student_phone_name_${tablephoneCounter}">
        </div>
        <div>
            <label for="student_phone_number_${tablephoneCounter}">電話番号</label>
            <input type="text" name="student_phone_number_${tablephoneCounter}" id="student_phone_number_${tablephoneCounter}" pattern="\\d+" placeholder="数字">
        </div>
    `;

    container.appendChild(form);
}


    function removeformStudentphone(studentPk) {
    const container = document.querySelector(`#student-list div[data-student-id="${studentPk}"] .student_phone_add`);
    const addedForms = container.querySelectorAll('.input-row');
   
    if (addedForms.length > 0) {
        // Remove the last added form
        const lastForm = addedForms[addedForms.length - 1];
        container.removeChild(lastForm);
        tablephoneCounter--;
    } else {
        // If there are no added forms, delete from the StudentPhone model
        const studentPhonesHtml = (response.student_phone_data[studentPk] || []);
        if (studentPhonesHtml.length > 0) {
            const lastPhone = studentPhonesHtml[studentPhonesHtml.length - 1];
            // Remove the last phone from the model or server

            $.ajax({
                url: '{% url "classmanager:delete_last_phone" %}', // Replace with your delete endpoint
                type: 'POST',
                data: { 
                    phoneId: lastPhone.id 
                },
                success: function(response) {
                    // Optionally, reload data or update UI accordingly
                },
                error: function(error) {
                    console.error('Error removing phone:', error);
                }
            });

            // Simulate removing it from the list
            studentPhonesHtml.pop();  
        }
    }
}

printList();
fetchSubjects();

$(document).ready(function() {
        function updateSchools(stage) {
            $.ajax({
                url: '{% url "classmanager:get_schools" %}',
                data: {
                    'stage': stage
                },
                dataType: 'json',
                success: function(data) {
                    $('#form_student_school').empty(); // 既存の選択肢をクリア
                    data.schools.forEach(function(school) {
                        $('#form_student_school').append(new Option(school, school));
                    });
                }
            });
        }
        
        // ページロード時に現在のstageに基づいて選択肢を更新
        const initialStage = $('#form_student_stage').val();
        updateSchools(initialStage);

        // stageが変更されたときの処理
        $('#form_student_stage').change(function() {
            const selectedStage = $(this).val();
            updateSchools(selectedStage);
        });
    });





    document.addEventListener('DOMContentLoaded', function() {
    let phoneCounter = 1; // 初期の電話番号入力フィールドのカウンター
    const phoneContainer = document.getElementById('student-phones-container');
    const addPhoneButton = document.getElementById('add-phone-btn');

    addPhoneButton.addEventListener('click', function() {
        phoneCounter++; // カウンターを増やす
        const newPhoneEntry = document.createElement('div');
        newPhoneEntry.classList.add('student-phone-entry');
        
        // 新しい電話番号フィールドの生成
        newPhoneEntry.innerHTML = `
        <div class="input-row">
            <div>
                <label for="student_phone_${phoneCounter}">誰の電話番号か</label>
                <input type="text" name="student_phone_name_${phoneCounter}" id="student_phone_name_${phoneCounter}">
            </div>
            <div>
                <label for="student_phone_number_${phoneCounter}">電話番号</label>
                <input type="text" name="student_phone_number_${phoneCounter}" id="student_phone_number_${phoneCounter}" pattern="\\d+" placeholder="数字">
            </div>
            </div>
        `;
        
        phoneContainer.appendChild(newPhoneEntry);
    });
});
</script>


{% endblock content %}

