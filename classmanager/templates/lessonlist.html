{% extends './base.html' %}
{% block content %}
<!-- Content Wrapper. Contains page content -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
 
<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
 

    
<style>
.content-wrapper{
  
}
.content{
    
}
.form{
    border: 5px solid #fafafa;
  padding: 1em;
    width: 100%;
  text-align: center;
  background-color: #ffffff;
}
.subject_box{
    
}
.subject_table{
    border: 5px solid #fafafa;
    padding: 1em;
    text-align: center;
    background-color: #ffffff;
  
}
.period_table{
    border: 5px solid #fafafa;
    padding: 1em;
    text-align: center;
    background-color: #ffffff;
  
}


.period_th{
    border: 2px solid #fafafa;
    background-color: #c2c1c1;
   
    
}
.period_td{
    
    border-bottom: 1px solid #b0b0b0;
    border-right: 2px solid #ffffff;
   background-color: #fafafa;
   height: 15px;
}
.period_title{
    width: 10%;
    min-width: 70px;
}
.period_start_time{
    width: 10%;
    min-width: 70px;
}
.period_end_time{
    width: 10%;
    min-width: 70px;
}
.period_check{
    width: 10%;
    min-width: 70px;
}

.subject_th{
    border: 2px solid #fafafa;
    background-color: #c2c1c1;
   
    
}
.subject_td{
    
    border-bottom: 1px solid #b0b0b0;
    border-right: 2px solid #ffffff;
   background-color: #fafafa;
   height: 15px;
   
}
.red_td{
    background-color: #f7e7db;
}
.blue_td{
    background-color: #d9eef3;
}
.subject_check{
    width:5%;
    min-width: 25px;
}
.subject_title{
    width: 10%;
    min-width: 70px;
}

.approval_button{
    position:absolute;
    top: 60%;
    right: 1%;
    width: 7%;
}
.detail_button{
    position:absolute;
    top: 20%;
    right: 1%;
    width: 7%;
}
.lesson_data{
    position:absolute;
    top: 5%;
    left: 1%;
    width: 100%;
}
.active_box{
    display: none;
}

    .student_table:hover {
        background-color: #252323; /* マウスオーバー時の背景色 */
    }
</style><div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
        <h1>授業一覧</h1>
        <ol class="breadcrumb">
            <li><a href="#"><i class="fa fa-dashboard"></i>授業</a></li>
            <li class="active">授業一覧</li>
        </ol>
    </section>
    <section class="content">
        <div class="box">
            <form method="POST">
                <div>
                    <label for="form_subject_title">科目名 <span class="text-sm text-danger">必須</span></label>
                    <input type="text" required value="" name="form_subject_title" id="form_subject_title">                     
                </div>
                <input type="button" value="保存" class="btn btn-primary" onclick="createSubject()">
            </form>
        </div>
        <div class="assessment_box">
            <table class="subject_table" style="border-collapse:collapse;border:none;">
                <thead>
                    <tr>
                        <td class="subject_th subject_check">
                            <input type="checkbox" id="subject_check" name="subject_check">
                        </td>
                        <td class="subject_th subject_title">
                            科目名
                        </td>
                    </tr>
                </thead>
            </table>
            <div id="subject-list">
                <!-- JavaScript will insert rows here -->
            </div>
        </div>


        <div class="box">
            <form method="POST" id="period-form">
                <div>
                    <label for="form_period_title">時限の名前 <span class="text-sm text-danger">必須</span></label>
                    <input type="text" required value="" name="form_period_title" id="form_period_title">                     
                </div>
                <div>
                    <label for="form_period_start_time">開始時刻 <span class="text-sm text-danger">必須</span></label>
                    <input type="time" required name="form_period_start_time" id="form_period_start_time">
                </div>
                <div>
                    <label for="form_period_end_time">終了時刻 <span class="text-sm text-danger">必須</span></label>
                    <input type="time" required name="form_period_end_time" id="form_period_end_time">
                </div>
                <input type="button" value="保存" class="btn btn-primary" onclick="createPeriod()">
            </form>
        </div>
        <div class="assessment_box">
            <table class="period_table" style="border-collapse:collapse;border:none;">
                <thead>
                    <tr>
                        <td class="period_th period_check">
                            <input type="checkbox" id="period_check" name="period_check">
                        </td>
                        <td class="period_th period_title">
                            時限名
                        </td>
                        <td class="period_th period_title">
                            開始時刻
                        </td>
                        <td class="period_th period_title">
                            終了時刻
                        </td>

                    </tr>
                </thead>
            </table>
            <div id="period-list">
                <!-- JavaScript will insert rows here -->
            </div>
        </div>
    </section>
</div>
<script>

document.addEventListener('click', function(event) {
    // Check if the click was on a subject_table or period_table
    const table = event.target.closest('.subject_table, .period_table');
    if (table) {
        const form = table.nextElementSibling;
        if (form && form.classList.contains('active_box')) {
            const isVisible = form.style.display === 'block';

            // Hide all forms
            document.querySelectorAll('.active_box').forEach(function(box) {
                box.style.display = 'none';
            });

            // Toggle the visibility of the clicked table's form
            form.style.display = isVisible ? 'none' : 'block';
        }
    }
});

function createSubject() {
    var form = document.querySelector('form');

    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const subjectTitle = document.getElementById('form_subject_title').value;

    // Ajaxリクエストを送信
    $.ajax({
        url: '{% url "classmanager:ajax_create_subject" %}', // 適切なURLを設定してください
        type: 'POST',
        data: {
            subject_title: subjectTitle,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function(response) {
            if (response.success) {
                alert("科目が保存されました。");
                printSubjectList(); // Saveしたら一覧を更新
            } else {
                alert("保存に失敗しました。");
            }
        },
        error: function() {
            alert("通信エラーが発生しました。");
        }
    });
}

const SubjectListElement = document.getElementById('subject-list');
const printSubjectList = () => {
    $.ajax({
        'url': '{% url "classmanager:ajax_get_printsubjectlist" %}',
        'type': 'GET',
    }).done(response => {
        SubjectListElement.innerHTML = '';
        let subjectList = response.subjectlist;
        console.log(subjectList )
        subjectList.forEach(subject => {
            const subjectFields = subject.fields; 
            const subjectPk = subject.pk;

            const row = document.createElement('div');
            row.setAttribute('data-subject-id', subjectPk);
            row.innerHTML = `
                <table class="subject_table" style="border-collapse:collapse;border:none;">
                    <tr>
                        <td class="subject_td subject_check">
                            <input type="checkbox" id="subject_check" name="subject_check">
                        </td>
                        <td class="subject_td subject_title">
                            ${subjectFields.title}
                        </td>
                    </tr>
                </table>
                <div class="active_box box" style="display: none;">
                    <form>
                        <div>
                            <label for="form_subject_title">科目名 <span class="text-sm text-danger">必須</span></label>
                            <input type="text" required value="${subjectFields.title}" name="form_subject_title" id="form_subject_title_${subjectPk}">
                        </div>
                        <div style="display:inline;">
                            <input type="button" value="保存" class="btn btn-primary" onclick="updateSubject(${subjectPk})">
                            <input type="button" value="削除" class="btn btn-danger" onclick="deleteSubject(${subjectPk})">
                        </div>
                    </form>
                </div>
            `;

            SubjectListElement.appendChild(row);
        });
        addTableListeners();
    });
};

function createPeriod() {
    // フォームの検証
    var form = document.getElementById('period-form');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    const periodTitle = document.getElementById('form_period_title').value;
    const periodStartTime = document.getElementById('form_period_start_time').value;
    const periodEndTime = document.getElementById('form_period_end_time').value;

    // 必須フィールドが入力されているか確認
    if (!periodTitle || !periodStartTime || !periodEndTime) {
        alert('全ての必須項目を入力してください。');
        return;
    }

    // AJAXリクエストを送信
    $.ajax({
        url: '{% url "classmanager:ajax_create_period" %}',
        type: 'POST',
        data: {
            title: periodTitle,
            start_time: periodStartTime,
            end_time: periodEndTime,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function(response) {
            if (response.success) {
                alert("時限が保存されました。");
                printPeriodList(); // 一覧を更新
            } else {
                alert("保存に失敗しました。");
            }
        },
        error: function() {
            alert("通信エラーが発生しました。");
        }
    });
}
const PeriodListElement = document.getElementById('period-list');
const printPeriodList = () => {
    $.ajax({
        'url': '{% url "classmanager:ajax_get_printperiodlist" %}',
        'type': 'GET',
    }).done(response => {
        PeriodListElement.innerHTML = '';
        let periodList = response.periodlist;
        
        periodList.forEach(period => {
            const periodFields = period.fields;
            const periodPk = period.pk;

            // 時間を HH:MM 形式にフォーマットする
            const formatTime = (time) => {
                const [hours, minutes] = time.split(':');
                return `${hours}:${minutes}`;
            };

            const formattedStartTime = formatTime(periodFields.start_time);
            const formattedEndTime = formatTime(periodFields.end_time);

            const row = document.createElement('div');
            row.setAttribute('data-period-id', periodPk);
            row.innerHTML = `
                <table class="period_table" style="border-collapse:collapse;border:none;">
                    <tr>
                        <td class="period_td period_check">
                            <input type="checkbox" id="period_check" name="period_check">
                        </td>
                        <td class="period_td period_title">
                            ${periodFields.title}
                        </td>
                        <td class="period_td period_start_time">
                            ${formattedStartTime}
                        </td>
                        <td class="period_td period_end_time">
                            ${formattedEndTime}
                        </td>
                    </tr>
                </table>
                
                    <div class="active_box box" style="display: none;">
    <form>
        <div>
            <label for="form_period_title">時限の名前 <span class="text-sm text-danger">必須</span></label>
            <input type="text" required value="${periodFields.title}" name="form_period_title" id="form_period_title_${periodPk}">
        </div>
        <div>
            <label for="form_period_start_time">開始時刻 <span class="text-sm text-danger">必須</span></label>
            <input type="time" required value="${formattedStartTime}" name="form_period_start_time" id="form_period_start_time_${periodPk}">
        </div>
        <div>
            <label for="form_period_end_time">終了時刻 <span class="text-sm text-danger">必須</span></label>
            <input type="time" required value="${formattedEndTime}" name="form_period_end_time" id="form_period_end_time_${periodPk}">
        </div>
        <div>
            <input type="button" value="保存" class="btn btn-primary" onclick="updatePeriod(${periodPk})">
            <input type="button" value="削除" class="btn btn-danger" onclick="deletePeriod(${periodPk})">
        </div>
    </form>
</div>
            `;

            PeriodListElement.appendChild(row);
        });
        addTableListeners(); // これが科目と時限の両方に対応するか確認
    });
};
// Call printSubjectList to initialize the subject list
printSubjectList();
printPeriodList();

function updateSubject(subjectId) {
    // 各フィールドから値を取得
    
    const form = document.querySelector(`#subject-list div[data-subject-id="${subjectId}"] form`);
    const subjectTitle = document.getElementById(`form_subject_title_${subjectId}`).value;
    
    if (!form.checkValidity()) {
        form.reportValidity(); // フォームエラーを表示する（ブラウザのデフォルトバリデーションを使用）
        return; // バリデーションに失敗した場合、処理を中断
    }
    
    // Ajaxでの更新処理を行う
    $.ajax({
        url: '{% url "classmanager:ajax_update_subject" %}',
        type: 'POST',
        data: {
            'subject_id': subjectId,
            'subject_title': subjectTitle,
            'csrfmiddlewaretoken': '{{ csrf_token }}' // CSRFトークンを含める
        },
        success: function(response) {
            if (response.success) {
                alert("科目が更新されました。");
                printSubjectList(); // 更新後のリストの再読み込み
            } else {
                alert(`更新に失敗しました: ${response.error || ''}`);
            }
        },
        error: function() {
            alert("通信エラーが発生しました。");
        }
    });
}

function deleteSubject(subjectId) {
    if (!confirm("本当に削除しますか？")) {
        return;  // ユーザーがキャンセルを選択した場合、処理を中止
    }
    $.ajax({
        url: '{% url "classmanager:ajax_delete_subject" %}',  // URLは適切なものに修正
        type: 'POST',
        data: {
            'subject_id': subjectId,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(response) {
            if (response.success) {
                alert("科目が削除されました。");
                printSubjectList();  // 削除したら一覧を更新
            } else {
                alert("削除に失敗しました: " + (response.error || ''));
            }
        },
        error: function() {
            alert("通信エラーが発生しました。");
        }
    });
}


function updatePeriod(periodId) {
    const form = document.querySelector(`#period-list div[data-period-id="${periodId}"] form`);
    const periodTitle = form.querySelector('input[name="form_period_title"]').value;
    const periodStartTime = form.querySelector('input[name="form_period_start_time"]').value;
    const periodEndTime = form.querySelector('input[name="form_period_end_time"]').value;

    if (!form.checkValidity()) {
        form.reportValidity(); // Show form errors
        return;
    }

    // Send the AJAX request for updating
    $.ajax({
        url: '{% url "classmanager:update_period" %}',
        type: 'POST',
        data: {
            'period_id': periodId,
            'period_title': periodTitle,
            'period_start_time': periodStartTime,
            'period_end_time': periodEndTime,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(response) {
            if (response.success) {
                alert("時限が更新されました。");
                printPeriodList(); // Refresh the list
            } else {
                alert(`更新に失敗しました: ${response.error || ''}`);
            }
        },
        error: function() {
            alert("通信エラーが発生しました。");
        }
    });
}

function deletePeriod(periodId) {
    if (!confirm("本当に削除しますか？")) {
        return; // Cancel if the user doesn't confirm
    }
    $.ajax({
        url: '{% url "classmanager:delete_period" %}',
        type: 'POST',
        data: {
            'period_id': periodId,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(response) {
            if (response.success) {
                alert("時限が削除されました。");
                printPeriodList(); // Refresh the list
            } else {
                alert(`削除に失敗しました: ${response.error || ''}`);
            }
        },
        error: function() {
            alert("通信エラーが発生しました。");
        }
    });
}
</script>


{% endblock content %}

