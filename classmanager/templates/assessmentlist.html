{% extends './base.html' %}
{% load static %}
{% block content %}
<!-- Content Wrapper. Contains page content -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
 
<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>

    
    
<style>
.content-wrapper{
  
}
.content{
    
}
.assessment_box{
    
}
.assessment_table{
    border: 5px solid #fafafa;
  padding: 1em;
    width: 100%;
  text-align: center;
  background-color: #ffffff;
  
}
td{
    
}
.assessment_th{
    border: 2px solid #fafafa;
    background-color: #c2c1c1;
   
    
}
.assessment_td{
    
    border-bottom: 1px solid #b0b0b0;
    border-right: 2px solid #ffffff;
   background-color: #fafafa;
   height: 150px;
   
}

.assessment_check{
    width: 25px;
    min-width: 25px;
}
.assessment_statusth{
    width: 80px;
    min-width: 80px;
    
}
.assessment_status{
    width: 80px;
    min-width: 80px;
    background-color: #97daeb;
}

.red_td{
    background-color: #f7e7db;
}
.blue_td{
    background-color: #d9eef3;
}

.assessment_time , .assessment_operation{
    width: 80px;
    min-width: 80px;
}

.assessment_date{
    width: 80px;
    min-width: 80px;
}
.assessment_classroom{
    width: 80px;
    min-width: 80px;
}
.assessment_text{
    width: 70%;
    min-width: 100px;
    position: relative;
    text-align: left;
}

.teacher_text{
    width: 60%;
    margin: 5px;
    position: absolute;
    top: 30px; /* 上を基準 */
    left: 0;      
}
.teacher_text textarea,.manager_text textarea{
  width: 80%;
  height: 85px;
}
.manager_text{
    width: 50%;
    margin: 5px;
    position: absolute;
    top: 30px; /* 上を基準 */
    left: 50%;      
}
.approval_button{
    position:absolute;
    top: 60%;
    right: 1%;
    width: 7%;
}
.detail_button{
    position:absolute;
    top: 20%;
    right: 1%;
    width: 7%;
}
.lesson_data{
    position:absolute;
    top: 5%;
    left: 1%;
    width: 100%;
}



    .tabs {
        display: flex;
        cursor: pointer;
        margin-bottom: 10px;
    }
    .tab {
        padding: 10px 20px;
        background: #ddd;
        margin-right: 5px;
        border-radius: 5px 5px 0 0;
    }
    .tab.active {
        background: #fff;
        border-bottom: 2px solid #fff;
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
</style>

<style>
    /* タブのスタイル */
    .tabs {
        display: flex;
        cursor: pointer;
        margin-bottom: 10px;
        flex-wrap: wrap;
    }

    .tab {
        padding: 10px 20px;
        background: #ddd;
        margin-right: 5px;
        border-radius: 5px 5px 0 0;
        font-weight: bold;
    }

    .tab.active {
        background: #fff;
        border-bottom: 2px solid #fff;
    }

   

    .tab-content {
        display: block;
        padding: 20px;
        background-color: #fff;
        border-radius: 5px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* 学生情報テーブル */
    .student-info {
        width: 100%;
        margin-bottom: 20px;
        border-collapse: collapse;
    }

    .student-info td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: left;
        font-size: 14px;
    }

    .student-info td:first-child {
        width: 150px;
        font-weight: bold;
    }

    /* フォームのスタイル */
  .nasi{
        background-color: #ffffff;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  width: 100%;
  max-width: 900px; /* 最大幅を指定 */
    }
    h4 {
  font-size: 1.5rem;
  color: #333;
  margin-bottom: 20px;
 
  font-weight: bold;
}
.form-group {
  display: flex;
  align-items: center;
  justify-content: flex-start; /* 左寄せ */
  gap: 20px; /* アイテム間の間隔 */
}

.flex {
  display: flex;
  align-items: center;
  justify-content: flex-start; /* 左寄せ */
  gap: 5px; /* アイテム間の間隔 */
}

    label {
        display: block;
        margin-bottom: 10px;
        font-weight: bold;
    }

    input[type="text"] {
        width: 100%;
        padding: 8px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 4px;
        margin-bottom: 15px;
    }

    input[type="text"]:focus {
        border-color: #007bff;
        outline: none;
    }

    button.save-button {
        background-color: #28a745;
        color: white;
        padding: 10px 20px;
        font-size: 16px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        width: 100%;
        transition: background-color 0.3s;
    }

    button.save-button:hover {
        background-color: #218838;
    }

    /* ボタンのスタイル */
    #add-tab-button {
        background-color: #007bff;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    #add-tab-button:hover {
        background-color: #0056b3;
    }

    /* タブにアクティブ状態を付与 */
    .tabs {
        justify-content: start;
    }

    .tab.active {
        background-color: #f1f1f1;
        border-bottom: 2px solid #007bff;
    }

    /* スクロールバーのデザイン */
    .tabs {
        overflow-x: auto;
    }

    .tabs::-webkit-scrollbar {
        height: 8px;
    }

    .tabs::-webkit-scrollbar-thumb {
        background-color: #007bff;
        border-radius: 10px;
    }

    .tabs::-webkit-scrollbar-track {
        background-color: #f1f1f1;

    }
    .image-options {
    display: flex;
    gap: 10px;
}

input[type="radio"] {
            display: none;
        }

.selectable-image {
    width: 100px;
    height: auto;

    cursor: pointer;
    border: 2px solid transparent;
    transition: border-color 0.3s;
}

textarea{
    width: 100%;
}

input[type="radio"]:checked + label .selectable-image {
    border-color: blue;
}

.tab.report-saved {
    background-color: rgb(83, 83, 83);
}

.tab-content.report-saved {
    background-color: rgb(83, 83, 83); /* フォームの暗い背景 */
    color: #fff; /* テキストを白にして読みやすくする */
}

.studentselecter_box {
    display: none;
    position: absolute; /* できるだけ絶対位置を使用 */
    z-index: 1000; /* 他の要素より前面に表示 */
    background: #fff;
    padding: 20px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    border: 1px solid #ccc; /* 追加のスタイリング */
}

</style>
<div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">      
        <h1>指導評価チェック</h1>
        <ol class="breadcrumb">
            <li><a href="#"><i class="fa fa-edit"></i> ホーム</a></li>
            <li class="active">指導評価チェック</li>
        </ol>
    </section>
    <section class="content">
       <div class="assessment_box">
            <table class="assessment_table">
                <thead>
                <tr >
                    <td class="assessment_th assessment_check">
                        <input type="checkbox">
                    </td>
                    <td class="assessment_th assessment_statusth">
                        処理
                    </td>
                    <td class="assessment_th"> 
                        日付
                    </td>
                    <td class="assessment_th"> 
                    生徒
                    </td>
                    <td class="assessment_th"> 
                        時限
                    </td>
                    <td class="assessment_th"> 
                        教室
                    </td>
                    <td class="assessment_th"> 
                        内容
                    </td>
                </tr>
            </thead>
            <tbody>
               
               </tbody>
            </table>
        </div>
 
     

    </section>
    
        <div class="studentselecter_box ">
            <span>教師 </span><span id="teacher-name"></span>
            <span>時限 </span><span id="period-title"></span>
          
            <div id="tab-contents">
                <!-- ここにテンプレートとしてのフォームを準備 -->
                <div id="form-template" class="tab-content">
                    <h4>♦生徒情報</h4>
                    <table class="student-info">
                        <!-- Student情報がここに表示されます -->
                    </table>
               

                    <form method="post">
                        {% csrf_token %}
                        <h4>♦事前チェック</h4>
                        <div class="form-group">
                        <div class="flex">
                        <label for="form-attendance">出欠:</label> 
                            <select required name="form-attendance" id="form-attendance">
                                <option value="出席">出席</option>
                                <option value="欠席">欠席</option>
                            </select>
                        </div>
                        <div class="flex">
                        <label for="form-behindtime">遅刻:</label> 
                            <select required name="form-behindtime" id="form-behindtime">
                                <option value="なし">なし</option>
                                <option value="10分">10分</option>
                                <option value="20分">20分</option>
                                <option value="30分~">30分~</option>
                            </select>
                        </div>
                        <div class="flex">
                        <label for="form-earlytime">早退:</label> 
                            <select required name="form-earlytime" id="form-earlytime">
                                <option value="なし">なし</option>
                                <option value="10分">10分</option>
                                <option value="20分">20分</option>
                                <option value="30分~">30分~</option>
                            </select>
                        </div>
                        <div class="flex">
                        <label for="form-achievement">宿題達成度:</label> 
                            <select required name="form-achievement" id="form-achievement">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                            </select>
                        </div>
                        
                        </div>
                    
                    <h4>♦指導評価</h4>
                  
                    <label for="form-teachermessage">指導後コメント:</label> 
                    <textarea required name="form-teachermessage" id="form-teachermessage"></textarea>
                    <!-- <input type="text" name="form-teachermessage" id="form-teachermessage">
                     -->
                    <div class="form-group">
                        <div class="flex">
                        <label for="form-poster">姿勢:</label> 
                            <select name="form-poster" id="form-poster">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                            </select>
                        </div>
                        
                        <div class="flex">
                        <label for="form-understand">理解:</label> 
                            <select name="form-understand" id="form-understand">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                            </select>
                        </div>
                    </div>
                        <label for="form-parentsmessage">保護者用評価:</label> 
                        <div class="image-options">
                            
                                <input type="radio" id="option1" name="form-parentsmessage" value="1">
                                <label for="option1">
                                    <img src="{% static 'img/option1.png' %}" alt="option1" class="selectable-image">
                                </label>
                                <input type="radio" id="option2" name="form-parentsmessage" value="2">
                                <label for="option2">
                                    <img src="{% static 'img/option2.png' %}" alt="option2" class="selectable-image">
                                </label>
                                <input type="radio" id="option3" name="form-parentsmessage" value="3">
                                <label for="option3">
                                    <img src="{% static 'img/option3.png' %}" alt="option3" class="selectable-image">
                                </label>
                                <input type="radio" id="option4" name="form-parentsmessage" value="4">
                                <label for="option4">
                                    <img src="{% static 'img/option4.png' %}" alt="option4" class="selectable-image">
                                </label>
                                <input type="radio" id="option5" name="form-parentsmessage" value="5">
                                <label for="option5">
                                    <img src="{% static 'img/option5.png' %}" alt="option5" class="selectable-image">
                                </label>
                            
                        </div>
                        <label for="form-nextlesson">次の授業:</label> 
                            <input required type="text" name="form-nextlesson" id="form-nextlesson">
                        <label for="form-homework">次の宿題:</label> 
                            <input required type="text" name="form-homework" id="form-homework">
                        <!-- 他のフィールドを追加 -->
                       
                        
                    </form>
                    
                </div>
            </div>
            <button type="button" class="save-button ">保存</button>
        </div>
    
</div>


<script>
    $(document).ready(function() {
        $(document).on('click', '.approval_button', function() {
    const row = $(this).closest('tr');
    const reportId = row.data('report-id');
    const teacherMessage = row.find('.teacher_text textarea').val();
    const managerMessage = row.find('.manager_text textarea').val();

    $.ajax({
        url: '{% url "classmanager:approve_report" %}',
        type: 'POST',
        data: {
            'report_id': reportId,
            'teacher_message': teacherMessage,
            'manager_message': managerMessage,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(response) {
            if (response.success) {
                row.find('.assessment_status').removeClass('red_td').text('承認済み');
                alert('レポートが更新されました');
            } else {
                alert('更新に失敗しました。');
            }
        },
        error: function() {
            alert('サーバーに接続中にエラーが発生しました。');
        }
    });
});
printreport();
function printreport(){
        $.ajax({
            url: '{% url "classmanager:get_reports" %}',
            type: 'GET',
            success: function(response) {
                const reports = response.reports;
                const tbody = $('.assessment_table tbody');
                tbody.empty();  // 以前のエントリをクリア
                
                reports.forEach(function(report) {
                    tbody.append(`
                        <tr data-report-id="${ report.id }">
                            <td class="assessment_td assessment_check">
                                <input type="checkbox">
                            </td>
                            <td class="assessment_td ${report.flag === '未承認' ? 'red_td' : ''} assessment_status">
                                ${report.flag}
                            </td>
                            <td class="assessment_td assessment_date">
                                ${report.date}
                            </td>
                            <td class="assessment_td assessment_time">
                                ${report.name}
                            </td>
                            <td class="assessment_td assessment_time">
                                ${report.time}
                            </td>
                            <td class="assessment_td assessment_classroom">
                                ${report.classroom}
                            </td>
                            <td class="assessment_td assessment_text">
                                <div class="lesson_data">
                                    出欠[ ${report.attendance} ] 遅刻[ ${report.behindtime} ] 早退[ ${report.earlytime} ] 姿勢[ ${report.poster} ] 理解[ ${report.understand} ] 宿題達成度[ ${report.achievement} ] 保護者用評価[ ${report.parentsmessage} ]
                                </div>
                                <div class="teacher_text">
                                    <div>教師から保護者へのメッセージ</div>
                                    <textarea>${report.teachermessage}</textarea>
                                </div>
                                <div class="manager_text">
                                    <div>管理者から次回へのメッセージ</div>
                                    <textarea>${report.managermessage}</textarea>
                                </div>
                                <button type="button" class="btn btn-primary approval_button">承認</button>
                                <button type="button" class="btn btn-secondary detail_button">詳細</button>
                            </td>
                        </tr>
                    `);
                });
            },
            error: function(error) {
                console.error('レポートの取得中にエラーが発生しました:', error);
            }
        });
    }


        $('.studentselecter_box').draggable();

// 詳細ボタンのクリックイベントを設定
$(document).on('click', '.detail_button', function(event) {
    const reportId = $(this).closest('tr').data('report-id');
    const detailButtonOffset = $(this).offset(); // ボタンの位置を取得
    $('.save-button').data('report-id', reportId);
    $.ajax({
        url: '{% url "classmanager:get_report_detail" %}',
        type: 'GET',
        data: { 'report_id': reportId },
        success: function(response) {
            if (response.success) {
                const report = response.report;
                const student = report.student;

                // 学生情報を表示
                const infoHTML = `<tr><td> 名前: ${student.name} </td> <td> 学校名: ${student.school} </td> <td> 教育段階: ${student.stage} </td> <td> 学年: ${student.grade} </td> <td> 組: ${student.schoolclass} </td> </tr>`;
                $('.student-info').html(infoHTML);

                // フォームにデータを設定
                $('#form-attendance').val(report.attendance || '出席');
                $('#form-behindtime').val(report.behindtime || 'なし');
                $('#form-earlytime').val(report.earlytime || 'なし');
                $('#form-achievement').val(report.achievement || '1');
                $('#form-poster').val(report.poster || '1');
                $('#form-understand').val(report.understand || '1');
                $(`input[name="form-parentsmessage"][value="${report.parentsmessage || '1'}"]`).prop('checked', true);
                $('#form-nextlesson').val(report.nextlesson || '');
                $('#form-homework').val(report.homework || '');
                $('#form-teachermessage').val(report.teachermessage || '');
               
                
                console.log(reportId)
                // boxの位置を調整し表示
                const boxWidth = $('.studentselecter_box').outerWidth();
                const boxHeight = $('.studentselecter_box').outerHeight();
                let left = event.clientX;
                let top = event.clientY;

                const windowWidth = $(window).width();
                const windowHeight = $(window).height();

                if (left + boxWidth > windowWidth) {
                    left = windowWidth - boxWidth - 10;
                }
                if (top + boxHeight > windowHeight+window.scrollY) {
                    top = windowHeight+window.scrollY - boxHeight - 10;
                }

                $('.studentselecter_box').css({ 'left': left + 'px', 'top': top + 'px' }).show();
            } else {
                alert('レポートの詳細を取得できませんでした。');
            }
        },
        error: function() {
            alert('レポートの取得中にエラーが発生しました。');
        }
    });
});


$(document).on('click', '.save-button', function() {
    const reportId = $(this).data('report-id');
    console.log(reportId);
    const formData = {
        'report_id': reportId,
        'attendance': $('#form-attendance').val(),
        'behindtime': $('#form-behindtime').val(),
        'earlytime': $('#form-earlytime').val(),
        'achievement': $('#form-achievement').val(),
        'poster': $('#form-poster').val(),
        'understand': $('#form-understand').val(),
        'parentsmessage': $('input[name="form-parentsmessage"]:checked').val(),
        'nextlesson': $('#form-nextlesson').val(),
        'homework': $('#form-homework').val(),
        'teachermessage': $('#form-teachermessage').val(),
        'csrfmiddlewaretoken': '{{ csrf_token }}'  // CSRFトークンの追加
    };

    $.ajax({
        url: '{% url "classmanager:update_report" %}',
        type: 'POST',
        data: formData,
        success: function(response) {
            if (response.success) {
                alert('レポートが更新されました！');
                // 必要に応じてUIリフレッシュなど
            } else {
                alert(response.error);
            }
        },
        error: function() {
            alert('サーバーへの接続中にエラーが発生しました。');
        }
    });
    $('.studentselecter_box').hide();
    printreport();
});
    });
    </script>
{% endblock content %}