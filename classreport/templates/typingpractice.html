{% extends 'basetyping.html' %}
{% load static %}
{% block title %}ENtyping {% endblock %}
{% block contents %}
<style>

.typing{
    font-size: 4em;
    text-align: center;
}
form{
    font-size: 2em;
    text-align: center;
}

.count {
    margin: 0;
    font-weight: bold;
    color: #634531;
}

.limit,.tani{
    margin: 0;
    font-weight: bold;
    color: #634531;
    font-size: 3rem
}
.wrap{
    margin-top: 20px;
    padding: 20px 40px;
    background-color: #ffebd4;
    font-weight: bold;
    color: #634531;
}

.start{
    font-size: 4em;
    text-align: center;
    margin: 20px
}
.typed{
    color: lightgreen;
}

.mistyped{
    background-color: #ed958a;
}
.tables{
    text-align: center;
}

table{
    margin: auto;
    font-size: 1rem;
    width: 50%;
    text-align: center;
    border-collapse: collapse;
    border-spacing: 0;
    color: #623f26;
  }



  table th{
    padding: 10px;
    border-bottom: solid 4px #634531;
    color: #623f26
  }

  table td{
    padding: 10px;
    border-bottom: solid 1px #624530;
  }

  .btnstart {
    display: inline-block;
    padding: 15px 40px;
    font-size: 2rem;
    font-weight: bold;
    color: white;
    text-align: center;
    background: linear-gradient(45deg, #faa63e, #f57c00);
    border: none;
    border-radius: 50px;
    box-shadow: 0 5px 15px rgba(250, 166, 62, 0.4);
    cursor: pointer;
    transition: all 0.3s ease-in-out;
    position: relative;
    overflow: hidden;
}

/* ホバーでふんわり光る */
.btnstart:hover {
    background: linear-gradient(45deg, #f57c00, #faa63e);
    box-shadow: 0 8px 20px rgba(250, 166, 62, 0.6);
    transform: scale(1.05);
}

/* クリック時のエフェクト */
.btnstart:active {
    transform: scale(0.98);
    box-shadow: 0 3px 10px rgba(250, 166, 62, 0.3);
}

/* 光のエフェクト */
.btnstart::before {
    content: "";
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 60%);
    opacity: 0;
    transition: opacity 0.4s ease-in-out;
}

/* ホバー時に光る */
.btnstart:hover::before {
    opacity: 1;
}

.form{
    color: #634531;
      font-size: 2rem;

      text-align-last: center;
     }

     .selectbox-2 {
    position: relative;
    margin-left:20px;
  }

  .selectbox-2::before,
  .selectbox-2::after {
    position: absolute;
    content: '';
    pointer-events: none;
  }

  .selectbox-2::before {
    right: 0;
    display: inline-block;
    width: 2em;
    height: 2em;
    border-radius: 0 3px 3px 0;
    background-color: #faa63e;
    content: '';
  }

  .selectbox-2::after {
    position: absolute;
    top: 50%;
    right: 1em;
    transform: translate(50%, -50%) rotate(45deg);
    width: 6px;
    height: 6px;
    border-bottom: 3px solid #fff;
    border-right: 3px solid #fff;
    content: '';
  }

  .selectbox-2 select {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    min-width: 230px;
    height: 2em;
    padding: 0.1em 2em .4em .1em;
    border: 2px solid #faa63e;
    border-radius: 3px;
    color: #634531;
    font-size: 1em;
    cursor: pointer;
  }

  .selectbox-2 select:focus {
    outline: 1px solid #f2d673;
  }
  .field {

    display: flex;
    align-items: center;
    justify-content: center;
    margin: auto;
    }
  .btn-custom{
    background-color: #faa63e;
    color: white;
  }
  .btn-custom:hover {
    background-color: #faa80e;
    color: #ffffff;
  }
  #id_name{
    color: #634531;
  }

  #student-form {
        background-color: #f9f9f9;
        padding: 10px;
        border-radius: 10px;
        width: 200px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        font-family: 'Arial', sans-serif;

        /* 画面の右上に固定 */
        position: fixed;
        top: 65px;  /* 上からの距離 */
        right: 20px; /* 右からの距離 */
        z-index: 1000; /* 他の要素の上に表示 */
    }

    /* ラベルのスタイル */
    #student-form label {
        font-size: 16px;
        font-weight: bold;
        color: #4e4e4e;
        margin-bottom: 10px;
        display: block;
    }

    /* 入力フィールドのスタイル */
    #student-form input[type="text"] {
        width: 100%;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
        outline: none;
        transition: border-color 0.3s;
    }

    #student-form input[type="text"]:focus {
        border-color: #ff8c00;  /* フォーカス時の色 */
    }

    /* ボタンのスタイル */
    #btncheck {
        width: 100%;
        padding: 12px;
        background-color: #74be4d; /* オレンジ色 */
        color: white;
        font-size: 16px;
        font-weight: bold;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.2s;
    }

    #btncheck:hover {
        background-color: #59913c;
        transform: translateY(-3px); /* ホバー時にボタンを少し持ち上げる */
    }

    #btncheck:active {
        background-color: #59913c;  /* クリック時 */
        transform: translateY(1px);  /* クリック時に少し下げる */
    }
    body {
  background-image: url(../image/back-img.jpg);
  background-repeat: no-repeat;
  background-size: cover;
  width: 100%;
  height: 100vh;
}
    .anime {
  position: relative;
}
    .rightimg {
    width: 260px;
    height: 300px;
  position: absolute;
  top: -200px;
  right: 15%;
  z-index: 9998; 
}
/*hiyoko Animation*/
.rightimg{
  animation: hiyoko 2.5s infinite 0s;
}
@keyframes hiyoko {
  0%   {
    transform: scale(1.0, 1.0) translate(0%, 0%); 
  }
  10%  { 
    transform: scale(1.04, 0.99) translate(0%, 0%);
  } 
  50%  { 
    transform: scale(1.03, 0.98) translate(0%, 5%); 
  }
  100% { 
    transform: scale(1.0, 1.0) translate(0%, 0%); 
  }
}
/*hiyoko image*/
.leftimg {
  width: 260px;
  height: 300px;
  position: absolute;
  top: -200px;
  left: 15%;
  z-index: 9998; 
}
/*hiyoko Animation*/
.leftimg{
  animation: hiyoko 2.5s infinite 0s;
}
@keyframes hiyoko {
  0%   {
    transform: scale(1.0, 1.0) translate(0%, 0%); 
  }
  10%  { 
    transform: scale(1.04, 0.99) translate(0%, 0%);
  } 
  50%  { 
    transform: scale(1.05, 0.95) translate(0%, 5%); 
  }
  100% { 
    transform: scale(1.0, 1.0) translate(0%, 0%); 
  }
}

#CMbox{
    position: absolute;  /* 画面の特定位置に固定 */
    left: 0px;         /* 右端に寄せる */
    top: 60px;           /* 上からの位置調整 */
    width: 200px;        /* 広告エリアの幅 */
    background-color: #f8f8f8; /* 背景色 */
    padding: 10px;
    text-align: center;
    border: 1px solid #ccc; /* 枠線 */
}

#typing-ad img {
    width: 100%;
    height: auto;
}

#typing-ad a {
    display: block;
    margin-top: 5px;
    color: blue;
    text-decoration: underline;
}
#typing-ad {
    position: relative;  /* 親要素に相対位置を指定 */
}

.typing-message {
    position: absolute;  /* 画像に重なるように配置 */
    bottom: 1px;  /* 画像の下部から10pxの距離 */
    left: 50%;  /* 画像の中央に配置 */
    transform: translateX(-50%);  /* 左右の中心に揃える */
    font-size: 14px;
    color: #fff;  /* 文字色を白に */
    font-weight: bold;
    background-color: rgba(0, 0, 0, 0.5);  /* 半透明の黒背景 */
    padding: 5px 10px;
    border-radius: 5px;  /* 角を丸くする */
    width: 150px;
}
#home-button {
        width: 100%;
        padding: 12px;
        background-color: #ab693a; /* オレンジ色 */
        color: white;
        font-size: 16px;
        font-weight: bold;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.2s;
    }

    #home-button a{
        color: white;
        text-decoration: none;
    }

    #home-button:hover {
        background-color: #361c0a;
        transform: translateY(-3px); /* ホバー時にボタンを少し持ち上げる */
    }

    #home-button:active {
        background-color: #3e1f09;  /* クリック時 */
        transform: translateY(1px);  /* クリック時に少し下げる */
    }
   

</style>
<div id="CMbox">
    <div id="home-button">
        <a href="{% url 'classreport:gameselect' %}">ホーム画面に戻る</a>
    </div>
    <div id="typing-ad">
      <a href="{% url 'classreport:transpractice' %}">
          <img src="{% static 'img/pandatitle.png' %}" alt="パンダタイピング">
          <p class="typing-message">リンガクイズ！</p>
      </a>
  </div>
</div>

        <meta charset="utf-8">
        <meta name="description" content="簡易的なタイピング">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
     
 

<audio id="id_audio1"    
    src="{% static "audio/se1.mp3" %}">
</audio>
<audio id="id_audio2"    
    src="{% static "audio/se2.mp3" %}">
</audio>
<audio id="id_audio3"    
    src="{% static "audio/se3.mp3" %}">
</audio>
<audio id="id_audio4"    
    src="{% static "audio/se4.mp3" %}">
</audio>
<div id="student-form">
    <label for="student_id">生徒IDを入力</label>
    <input type="text" id="student_id" name="student_id" required>
    <button id="btncheck" class="btncheck">テストを開始する</button>
</div>
<div class='field'>
    <h2 id='id_name' class='m-3'>タイピング練習</h2>
    
    </div>
<div class='typing'>
    <list class="limit" id='limit'>目標時間</list>
    <list id="count" class="count"></list>
    <list class="tani">秒</list>
</div>
        <div class=" py-3 bg-white">
        <div class='form'>

        <label for="id_parent"class='selectbox-2'>教材:
        <select name="parent_category" id="id_parent">
        <option value="" selected>---------</option>
        </select></label>
        <label for="id_category" class='selectbox-2'>カテゴリ:
        <select name="parent_category" id="id_category">
        <option value="" selected>---------</option>
        </select></label>
        </div>
        <div class='typing'>
            <div></div>
            <button id="start" class="btnstart mt-3">スタート Enter↲ </button>

        
            <div id="wrap" class="wrap">
                <div class="anime">
                    <img class='leftimg' id="id_leftimg" style="display: none" src='{% static "img/pandal.png"%}'>
                    <img class='rightimg' id="id_rightimg" style="display:none" src='{% static "img/pandar.png"%}'>
                    <img class='pandaneru' id="id_pandaneru" style="display: none" src='{% static "img/pandaneru.png"%}'>
                    <img class='pandatensi' id="id_pandatensi" style="display: none" src='{% static "img/pandatensi.png"%}'>
                    </div>  

                    <div>
                        <p id="trans" ></p>
                        <span id="typed" class="typed"></span>
                        <span id="untyped"></span>
                        <h1 id="end"></h1>
                    </div>
                        <div class="tables">
                        <table id="tbl1"  >

                        </table>
                    </div>


            </div>
        </div>
    </div>

    {% endblock %}

    {% block extrajs %}
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.3.2/dist/confetti.browser.min.js"></script>

    <script>
let untyped='';
        let typed='';
        let score=0;
        var textLists;
        var transLists
        var untypedfield=document.getElementById('untyped');
        const typedfield=document.getElementById('typed');
        const wrap = document.getElementById('wrap');
        const start=document.getElementById('start')
        const limit=document.getElementById('limit')
        const count=document.getElementById('count')
        const audio1=document.getElementById('id_audio1')
        var audio2=document.getElementById('id_audio2')
        const audio3=document.getElementById('id_audio3')
        const audio4=document.getElementById('id_audio4')
        const transfield=document.getElementById('trans');
        const endfield=document.getElementById('end');
        var select=document.getElementById('select');
        const tbl=document.getElementById('tbl1');
        var parentselect=document.getElementById('parentselect');
        const studentnameElement = $('#id_name');
        const parentCategoryElement = $('#id_parent');
        const categoryElement = $('#id_category');
        const wordvalueElement = $('#wordvalue');
        const transvalueElement = $('#transvalue');
        const mypagelink = $('#mypagelink')
        const leftimg=$('#id_leftimg')
            const rightimg=$('#id_rightimg')
            const pandatensi=$('#id_pandatensi')
            const pandaneru=$('#id_pandaneru')
    


        $(document).ready(function() {
    


            
    $('#btncheck').on('click', function() {
        const studentId = $('#student_id').val();
        if (!studentId) {
            alert('Please enter a Student ID.');
            return;
        }

        $.ajax({
            url: '{% url "classreport:check_student_exists" %}', // Your API endpoint to check student existence
            method: 'POST',
            data: {
                'student_id': studentId,
                // Assuming you have a CSRF token setup in your project, include it here
            },
            success: function(response) {
                if (response.exists) {
                    // Hide form on game start
                    window.location.href = `typing/${studentId}`; // Redirect to typing page
                } else {
                    alert('Student not found in the current class.');
                }
            }
        });
    });

    // Function to show the form after the game ends
    function showStudentForm() {
        $('#student-form').show();
    }

    // Call showStudentForm() after the game ends in gameOver and gameClear functions
});

        const printselect=()=>{
              console.log('chans')
              var category_value=1;
              console.log(category_value)
              $.ajax({
                  url: '{% url "classreport:ajax_get_printlist" %}',
                  type: 'GET',
                  data: {
                    'pk': category_value,
                        }
                }).done(response => {

                      var textLists=response.message4;
                      textId=response.message5;
                      console.log(textLists)

                      for(let i=0; i<textLists.length; i++){
                        const select=document.getElementById('id_parent');
                        let option=document.createElement('option');
                        option.text=textLists[i];
                        option.value=textId[i];

                        select.appendChild(option);
                      }
                  });
                };

        

                const changeCategory = (select) => {
                    categoryElement.children().remove();
                    $.ajax({
                        url: '{% url "classreport:ajax_get_printlist" %}',
                        type: 'GET',
                        data: {
                            'pk': parentCategoryElement.val(),
                        }
                    }).done(response => {
                      var textLists=response.message3;
                      textId=response.message6;
                      console.log(textLists)
                      for(let i=0; i<textLists.length; i++){
                        const select=document.getElementById('id_category');
                        let option=document.createElement('option');
                        option.text=textLists[i];
                        option.value=textId[i];

                        select.appendChild(option);
                      }
                        printlist();
                    });
                };

            
                parentCategoryElement.on('change', () => {
                    changeCategory();
                    console.log('change');
                });

                printselect();
                parentCategoryElement.on("change",()=>{
                    printlist();
                })

                categoryElement.on("change",()=>{
                    printlist();
                })

            typedfield.textContent='';
            untypedfield.textContent='スタートを押してください';

            const printlist=()=>{
                $.ajax({
                        url: '{% url "classreport:ajax_get_printlist" %}',
                        type: 'GET',
                        data: {
                            'pk': categoryElement.val(),
                        }
                    }).done(response => {
                        var resultDiv=document.getElementById('result');
                        textLists=response.message;
                        transLists=response.message2;
                        console.log(textLists)
                        console.log(transLists)
                        let time=count.textContent;
                        var wordcount=0;
                        for(i=0;i<textLists.length;i++){
                            wordcount+=textLists[i].length;
                            }
                        let long=Math.round(wordcount*1.5);
                        count.textContent=long;

                        var table = document.getElementById("tbl1");  // 行の削除
                        while (table.rows.length > 0) table.deleteRow(0);
                        for(let i=0; i<textLists.length; i++){
                            const tbl=document.getElementById('tbl1');
                            let tr=document.createElement('tr');
                            let cell=document.createElement('td');
                            let celltext=document.createTextNode(textLists[i]);
                            cell.appendChild(celltext);
                            let cell2=document.createElement('td');
                            let celltrans=document.createTextNode(transLists[i]);
                            cell2.appendChild(celltrans);
                            tr.appendChild(cell);
                            tr.appendChild(cell2);
                           tbl.appendChild(tr);
                        }
                    } ) 
                    
                }
            
            mistypetransLists=[];
            mistypetextLists=[];
        
            const printmistypelist=()=>{
                const tbl=document.getElementById('tbl1');
                let tr=document.createElement('tr');
                let cell=document.createElement('td');
                let celltext=document.createTextNode(textLists[counter]);
                cell.appendChild(celltext);
                tr.appendChild(cell);
                let cell2=document.createElement('td');
                let celltrans=document.createTextNode(transLists[counter]);
                cell2.appendChild(celltrans);
                tr.appendChild(cell2);
                tbl.appendChild(tr);

                mistypetextLists.push(textLists[counter]);
                mistypetransLists.push(transLists[counter]);

                gameinfo=1;
            }

            var counter=0;
            let random;



            const createText =()=>{
               {

                typed='';
                typedfield.textContent=typed;
                transfield.textContent=transLists[counter];
                untyped = textLists[counter];

                
                untypedfield.textContent= untyped


            };}

        

            const keyPress=e=>{
                console.log(e.key);
                if(e.key !==untyped.substring(0,1)){
                    wrap.classList.add('mistyped')
                    setTimeout(()=>{
                        wrap.classList.remove('mistyped')
                    },100)
                    new Audio('{% static "audio/se2.mp3" %}').play();
                    
                    return;
                }

                score++;
                typed+=untyped.substring(0,1);
                untyped=untyped.substring(1);
                typedfield.textContent=typed;
                console.log(untyped.length)
                untypedfield.textContent=untyped;
                if(untyped===''){
                    counter++;
                    audio1.play();
                    createText();
                }
            };
            const rankCheck=score=>{
                let text='';
                return  `時間切れです\n早く打てるように練習しましょう\n【OK】リトライ / 【キャンセル】終了`

            };

            const rankCheckClear=score=>{
                let text='';
                return  `制限時間内にすべての単語を打てました\nおめでとうございます\n【OK】リトライ / 【キャンセル】終了`

            };

            const gameOver=id=>{
                $('body').css('overflow', '');
                counter=0;
                gamestate=0;
                gameinfo=0;
                clearInterval(id);
                audio4.play();
                transfield.textContent='時間切れ';
                typedfield.textContent='';
                untypedfield.textContent='もっと練習しよう！';
                endfield.textContent='';
                start.style.display = '';
                limit.style.display = '';
                start.textContent='再スタート Enter↲ '
                printlist();
             };


             const gameClear=id=>{
                counter=0;
                gamestate=0;
                if(gameinfo==0){
                    clearInterval(id);
                    $('body').css('overflow', '');

                    $('.field').show();
                    $('.leftimg').show();
                    $('.rightimg').show();
                    var countanime = 200;
                    var defaults = {
                    origin: { y: 0.7 }
                    };

            function fire(particleRatio, opts) {
                confetti({
                    ...defaults,
                    ...opts,
                    particleCount: Math.floor(countanime * particleRatio)
                });
                }

            fire(0.25, {
                spread: 26,
                startVelocity: 55,
            });
            fire(0.2, {
                spread: 60,
            });
            fire(0.35, {
                spread: 100,
                decay: 0.91,
                scalar: 0.8
            });
            fire(0.1, {
                spread: 120,
                startVelocity: 25,
                decay: 0.92,
                scalar: 1.2
            });
            fire(0.1, {
                spread: 120,
                startVelocity: 45,
            });
                $('.field').show();
                categoryElement.show();
                parentCategoryElement.show();
                $("label[for='id_parent']").show();
                $("label[for='id_category']").show(); 
                $('#student-form').show();        
                typedfield.textContent='よくできました！';
                audio3.play();
                untypedfield.textContent='';
                endfield.textContent='';
                start.style.display = '';
                limit.style.display = '';
                start.textContent='スタート Enter↲ '
                printlist();
            }else{
                $('body').css('overflow', '');
                typedfield.textContent='';
                transfield.textContent='間違えた単語があります';
                untypedfield.textContent='よく確認してから再スタートしてください';
                endfield.textContent='';
                start.style.display = '';
                limit.style.display = '';
                start.textContent='再スタートEnter↲  '
            }
            }

            

            const timer=()=>{
                let time=count.textContent;
                const id =setInterval(()=>{
                    time--;
                    count.textContent=time;
                    if(time<=0 ){

                        gameOver(id);
                    }else if(counter==textLists.length ){
                        if(mistypetextLists.length==0){
                            gameinfo=0;
                        }
                        gameClear(id);
                    }
                },1000);
            };
            var gamestate=0;
            var gameinfo=0;



            const startgame=()=>{
                $('body').css('overflow', 'hidden');
                $('.leftimg').hide();
                $('.rightimg').hide();
                createText();
                timer();
                $('.field').hide();
                categoryElement.hide();
                parentCategoryElement.hide();
                $("label[for='id_parent']").hide();
                $("label[for='id_category']").hide();
                $('#student-form').hide(); 
                start.style.display='none';
                limit.style.display='none';
                var table = document.getElementById("tbl1");  // 行の削除
                while (table.rows.length > 0) table.deleteRow(0);
                endfield.textContent='';
                document.addEventListener('keypress',keyPress);
                trans.style.display='';
                gamestate=1;
                }

            untypedfield.textContent='';
            start.addEventListener('click',()=>{
                startgame();
            });

            window.document.onkeyup = function(event){
                if (event.key === 'Enter') {
                    if(gamestate==0){
                    startgame();
                }else{
                    return false;
                }
                }
            }




</script>
            {% endblock %}
