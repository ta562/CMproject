{% extends 'baselite.html' %}
{% block content %}
<!-- Content Wrapper. Contains page content -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>

    
<style>
.content-wrapper{
  
}
.content{
    
}
.assessment_box{
    
}
.assessment_table{
    border: 5px solid #fafafa;
  padding: 1em;
    width: 100%;
  text-align: center;
  background-color: #ffffff;
  
}
td{
    
}
.assessment_th{
    border: 2px solid #fafafa;
    background-color: #c2c1c1;
   
    
}
.assessment_td{
    
    border-bottom: 1px solid #b0b0b0;
    border-right: 2px solid #ffffff;
   background-color: #fafafa;
   height: 150px;
   
}
.red_td{
    background-color: #f7e7db;
}
.blue_td{
    background-color: #d9eef3;
}
.assessment_check{
    width: 25px;
    min-width: 25px;
}
.assessment_status{
    width: 80px;
    min-width: 80px;
}
.assessment_time , .assessment_operation{
    width: 80px;
    min-width: 80px;
}
.assessment_text{
    width: 70%;
    min-width: 100px;
    position: relative;
    text-align: left;
}

.teacher_text{
    width: 60%;
    margin: 5px;
    position: absolute;
    top: 30px; /* 上を基準 */
    left: 0;      
}
.teacher_text textarea,.manager_text textarea{
  width: 80%;
  height: 85px;
}
.manager_text{
    width: 50%;
    margin: 5px;
    position: absolute;
    top: 30px; /* 上を基準 */
    left: 50%;      
}
.approval_button{
    position:absolute;
    top: 60%;
    right: 1%;
    width: 7%;
}
.detail_button{
    position:absolute;
    top: 20%;
    right: 1%;
    width: 7%;
}
.lesson_data{
    position:absolute;
    top: 5%;
    left: 1%;
    width: 100%;
}

</style>
<div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">      
        <h1>教師選択</h1>
    </section>
    <section class="content">
        <div class="teacherselect_box">
            <input type="text" id="teacher_id_input" placeholder="教師のIDを入力">
            
            <button id="confirm_button">確定</button>
            <div class="form-group">
                <label for="search-period-select">時限</label>
                <select id="search-period-select" class="form-control">
                    <!-- 時限のオプションをここに -->
                </select>
            </div>
        </div>
    </section>
</div>

<!-- jQueryを読み込む -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(document).ready(function() {
    // 時限のオプションを取得してドロップダウンを更新する関数
    function loadPeriodOptions() {
        $.ajax({
            url: '/get_period_options/',
            type: 'GET',
            success: function(data) {
                if (data.success) {
                    var select = $('#search-period-select');
                    select.empty(); // 既存のオプションをクリア
                    
                    data.periods.forEach(function(period) {
                        var option = $('<option></option>')
                            .attr('value', period.id)
                            .text(`${period.title} (${period.start_time} - ${period.end_time})`);
                        select.append(option);
                    });
                } else {
                    alert('時限の情報を取得できませんでした。');
                }
            },
            error: function(xhr, status, error) {
                alert('時限の情報をロード中にエラーが発生しました。');
            }
        });
    }

    // ページ読み込み時に時限オプションをロード
    loadPeriodOptions();

    // 確定ボタンの動作
    $('#confirm_button').click(function() {
        var teacherID = $('#teacher_id_input').val();
        var selectedPeriodID = $('#search-period-select').val(); // 選択された時限IDを取得

        $.ajax({
            url: '/check_teacher_id/',
            type: 'POST',
            data: JSON.stringify({ teacher_id: teacherID }),
            contentType: 'application/json',
            beforeSend: function(xhr, settings) {
                xhr.setRequestHeader("X-CSRFToken", getCSRFToken());
            },
            success: function(data) {
                if (data.success) {
                    window.location.href = `/report_create/${data.teacher_id}/${selectedPeriodID}`;
                } else {
                    alert('教師IDが正しくありません。');
                }
            },
            error: function(xhr, status, error) {
                alert('サーバーとの通信に問題が発生しました。');
            }
        });
    });

    function getCSRFToken() {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, 10) === ('csrftoken=')) {
                    cookieValue = decodeURIComponent(cookie.substring(10));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock content %}